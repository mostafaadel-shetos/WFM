<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Type Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .request-path { font-size: 0.75rem; margin-bottom: 0.5rem; font-weight: 500; }
        @keyframes pulse-border {
            0% { border-color: rgba(79, 70, 229, 0.4); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.2); }
            70% { border-color: rgba(79, 70, 229, 1); box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); }
            100% { border-color: rgba(79, 70, 229, 0.4); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        .best-match {
            border: 2px solid #4f46e5;
            animation: pulse-border 2s infinite;
        }
        .logo-text {
            font-family: 'Arial Black', 'Helvetica Neue', sans-serif;
            letter-spacing: -0.05em;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">
    <div id="app" class="min-h-screen p-4 sm:p-8"></div>

    <script type="module">
        // ===================================================================
        // ðŸŸ¢ CONFIGURATION
        // ===================================================================
        
        // 1. Google Sheet Data Link (Published as CSV)
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvs2dBHF01vfJADCqiPjvM1ZFrZ9DRQpBbMC57BHK-kFe2KK7TmZiIaQXUoaEelVuqh-AZzS5HKEoG/pub?output=csv'; 
        
        // 2. Logo Link
        const LOGO_URL = 'https://i.ibb.co/MkQ18QyV/Logo.png';

        // ===================================================================

        const STOP_WORDS = new Set([
            'a', 'an', 'the', 'and', 'or', 'but', 'is', 'are', 'was', 'were', 'be', 'been', 
            'in', 'on', 'at', 'to', 'for', 'from', 'of', 'with', 'by', 'about', 
            'i', 'my', 'me', 'we', 'our', 'us', 'you', 'your', 'he', 'his', 'him', 'she', 'her', 'it', 'its', 'they', 'their', 'them', 
            'this', 'that', 'these', 'those', 'have', 'has', 'had', 'do', 'does', 'did', 
            'can', 'could', 'will', 'would', 'should', 'want', 'wants', 'need', 'needs', 'please', 'help', 'hi', 'hello', 
            'regarding', 'issue', 'problem', 'question', 'ask', 'asking', 'customer', 'client', 'user', 'very', 'upset', 'angry', 'because'
        ]);

        const PRODUCT_MAP = {
            'studio': 'Tempo Studio',
            'move': 'Tempo Move',
            'core': 'Tempo Core',
            'byod': 'BYOD',
            'accessory': 'Accessories',
            'accessories': 'Accessories',
            'weight': 'Accessories',
            'weights': 'Accessories',
            'dumbbell': 'Accessories',
            'dumbbells': 'Accessories',
            'barbell': 'Accessories'
        };

        let requestTypesData = [];
        let wordFrequency = {}; 
        let totalDocuments = 0;

        let selectedL1 = '';
        let selectedL2 = '';
        let selectedL3 = '';
        let currentFinalRequest = null;
        let searchTerm = '';
        let isLoading = true;
        let errorMsg = null;
        
        let isDarkMode = localStorage.getItem('theme') === 'dark';
        const appDiv = document.getElementById('app');

        if (isDarkMode) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');

        function simpleStem(word) {
            if (word.length < 4) return word;
            if (word.endsWith('ing')) return word.slice(0, -3);
            if (word.endsWith('ed')) return word.slice(0, -2);
            if (word.endsWith('es')) return word.slice(0, -2);
            if (word.endsWith('s') && !word.endsWith('ss')) return word.slice(0, -1);
            return word;
        }

        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let col = 0;
            let row = 0;
            let c = 0;
            for (; c < str.length; c++) {
                let cc = str[c], nc = str[c + 1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';
                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
                if (cc == '"') { quote = !quote; continue; }
                if (cc == ',' && !quote) { ++col; continue; }
                if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
                if (cc == '\n' && !quote) { ++row; col = 0; continue; }
                if (cc == '\r' && !quote) { ++row; col = 0; continue; }
                arr[row][col] += cc;
            }
            return arr;
        }

        function buildSearchIndex(data) {
            wordFrequency = {};
            totalDocuments = data.length;

            data.forEach(item => {
                const text = `${item.L1} ${item.L2} ${item.L3} ${item.description}`.toLowerCase();
                const tokens = text.replace(/[.,/#!$%^&*;:{}=\-_`~()]/g," ").split(/\s+/);
                const uniqueTokens = new Set();
                tokens.forEach(t => {
                    if (t.length > 2 && !STOP_WORDS.has(t)) {
                        uniqueTokens.add(simpleStem(t));
                    }
                });
                uniqueTokens.forEach(token => {
                    wordFrequency[token] = (wordFrequency[token] || 0) + 1;
                });
            });
        }

        async function fetchData() {
            isLoading = true;
            errorMsg = null;
            selectedL1 = ''; selectedL2 = ''; selectedL3 = '';
            currentFinalRequest = null; searchTerm = '';
            renderApp(); 

            try {
                const timestamp = new Date().getTime();
                const response = await fetch(`${GOOGLE_SHEET_CSV_URL}&t=${timestamp}`);
                if (!response.ok) throw new Error("Failed to fetch CSV");
                const text = await response.text();

                if (text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")) {
                    throw new Error("Incorrect Link Type. Please check the Google Sheet publish settings.");
                }
                
                const rows = parseCSV(text);
                const data = rows.slice(1).map(row => {
                    if (row.length < 3) return null; 
                    return {
                        L1: row[0]?.trim() || "",
                        L2: row[1]?.trim() || "",
                        L3: row[2]?.trim() || "",
                        description: row[3]?.trim() || ""
                    };
                }).filter(item => item !== null && item.L1); 

                requestTypesData = data;
                buildSearchIndex(data); 
                
                isLoading = false;
                renderApp();
            } catch (error) {
                console.error(error);
                isLoading = false;
                errorMsg = error.message;
                renderApp();
            }
        }

        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function getUniqueOptions(levelKey, filterL1 = '', filterL2 = '') {
            let filteredData = requestTypesData;
            if (filterL1) filteredData = filteredData.filter(item => item.L1 === filterL1);
            if (filterL2) filteredData = filteredData.filter(item => item.L2 === filterL2);
            
            const seen = new Set();
            const result = [];
            for (const item of filteredData) {
                const val = item[levelKey];
                if (val && !seen.has(val)) {
                    seen.add(val);
                    result.push(val);
                }
            }
            return result;
        }

        function handleThemeToggle() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            renderApp();
        }

        function handleL1Change(event) {
            selectedL1 = event.target.value;
            selectedL2 = ''; selectedL3 = ''; currentFinalRequest = null;
            renderApp();
        }
        function handleL2Change(event) {
            selectedL2 = event.target.value;
            selectedL3 = ''; 
            const l3Options = getUniqueOptions('L3', selectedL1, selectedL2);
            if (l3Options.length === 0) {
                currentFinalRequest = requestTypesData.find(item => 
                    item.L1 === selectedL1 && item.L2 === selectedL2 && (!item.L3 || item.L3.trim() === "")
                );
            } else {
                currentFinalRequest = null;
            }
            renderApp();
        }
        function handleL3Change(event) {
            selectedL3 = event.target.value;
            currentFinalRequest = requestTypesData.find(item => 
                item.L1 === selectedL1 && item.L2 === selectedL2 && item.L3 === selectedL3
            );
            renderApp();
        }
        function handleResetTree() {
            selectedL1 = ''; selectedL2 = ''; selectedL3 = '';
            currentFinalRequest = null;
            renderApp();
        }
        function handleSearchInput(event) {
            searchTerm = event.target.value;
            debouncedUpdateSearch(searchTerm);
        }
        const debouncedUpdateSearch = debounce((term) => renderApp(term), 300);

        function getIcon(name) {
            const colorClass = "text-gray-400 dark:text-gray-500";
            const brandColor = "text-indigo-600 dark:text-indigo-400";
            if(name === 'Search') return `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${colorClass}"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`;
            if(name === 'Check') return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${brandColor}"><path d="M22 11.08V12a10 10 0 1 1-5.84-8.82"/><path d="M9 11l3 3 7-7"/></svg>`;
            if(name === 'Loader') return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin ${brandColor}"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>`;
            if(name === 'Refresh') return `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`;
            if(name === 'Moon') return `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
            if(name === 'Sun') return `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
            if(name === 'Star') return `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
            if(name === 'X') return `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            return '';
        }

        function renderDropdown(id, label, options, selected, enabled) {
            const opts = options.map(o => `<option value="${o}" ${o === selected ? 'selected' : ''}>${o}</option>`).join('');
            return `
                <div class="flex flex-col space-y-1">
                    <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">${label}</label>
                    <select id="${id}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 ${!enabled ? 'bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500' : ''}" ${!enabled ? 'disabled' : ''}>
                        <option value="" disabled ${!selected ? 'selected' : ''}>
                            ${!enabled && options.length === 0 ? 'N/A' : 'Select...'}
                        </option>
                        ${opts}
                    </select>
                </div>`;
        }

        function renderCard(req, score = null, isBestMatch = false) {
            const fullTree = [req.L1, req.L2, req.L3].filter(Boolean).join(' > ');
            
            let scoreBadge = '';
            if (score !== null) {
                let badgeColor = 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300';
                if (score >= 80) badgeColor = 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200';
                else if (score >= 50) badgeColor = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200';
                
                scoreBadge = `<div class="flex items-center gap-2 flex-shrink-0 ml-2">
                    ${isBestMatch ? `<span class="flex items-center gap-1 text-xs font-bold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded-full border border-indigo-200 dark:border-indigo-800 whitespace-nowrap">${getIcon('Star')} Best Match</span>` : ''}
                    <span class="text-xs font-bold px-2 py-1 rounded-full ${badgeColor} whitespace-nowrap">${score}% Fit</span>
                </div>`;
            }

            const cardClass = isBestMatch ? 'best-match relative z-10' : '';

            return `
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all ${cardClass}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="text-indigo-600 dark:text-indigo-400 text-sm font-bold tracking-wide break-words leading-snug w-full pr-2">${fullTree}</div>
                        ${scoreBadge}
                    </div>
                    
                    <div class="flex items-start gap-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                        <div class="mt-1 flex-shrink-0">${getIcon('Check')}</div>
                        <div class="w-full">
                            <div class="text-base text-gray-700 dark:text-gray-200 leading-relaxed">
                                <span class="font-semibold text-gray-900 dark:text-white block mb-1">Description:</span>
                                ${req.description || "No description provided."}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function calculateScore(item, tokens) {
            let weightedScore = 0;
            let maxPossibleScore = 0;
            
            const l3 = (item.L3 || '').toLowerCase();
            const l2 = (item.L2 || '').toLowerCase();
            const l1 = (item.L1 || '').toLowerCase();
            const desc = (item.description || '').toLowerCase();

            tokens.forEach(token => {
                const stem = simpleStem(token);
                const freq = wordFrequency[stem] || 1;
                const weight = Math.log(totalDocuments / (freq + 1)) + 1; 
                
                maxPossibleScore += weight * 5; 

                if (desc.includes(token) || desc.includes(stem)) {
                    weightedScore += weight * 5; 
                }
                
                if (l3.includes(token) || l3.includes(stem)) {
                    weightedScore += weight * 3; 
                    if (desc.includes(token) || desc.includes(stem)) {
                        weightedScore += weight * 2; 
                    }
                }
                
                if (l2.includes(token) || l2.includes(stem) || l1.includes(token) || l1.includes(stem)) {
                    weightedScore += weight * 1;
                }
            });

            const normalizedScore = Math.min(100, Math.round((weightedScore / (maxPossibleScore * 0.6)) * 100));
            
            return { 
                ...item, 
                displayPercent: normalizedScore,
                sortScore: weightedScore 
            };
        }

        function renderSearchPanel(currentSearchTerm) {
            const normalizedTerm = currentSearchTerm.toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g," ");
            const tokens = normalizedTerm.split(/\s+/).filter(t => t.length > 2 && !STOP_WORDS.has(t)); 
            
            const activeProductFilters = [];
            const remainingTokens = [];
            
            tokens.forEach(t => {
                const stemT = simpleStem(t);
                if (PRODUCT_MAP[t] || PRODUCT_MAP[stemT]) {
                    activeProductFilters.push(PRODUCT_MAP[t] || PRODUCT_MAP[stemT]);
                } else {
                    remainingTokens.push(t);
                }
            });

            let activeData = requestTypesData;
            if (activeProductFilters.length > 0) {
                activeData = activeData.filter(item => {
                    return activeProductFilters.some(filter => (item.L1 || '').includes(filter));
                });
            }

            let searchResults = [];
            
            if (remainingTokens.length > 0) {
                searchResults = activeData.map(item => calculateScore(item, remainingTokens))
                .filter(item => item.displayPercent > 5) 
                .sort((a, b) => b.sortScore - a.sortScore);
            } 
            else if (activeProductFilters.length > 0) {
                 searchResults = activeData.slice(0, 10).map(item => ({...item, displayPercent: 100}));
            }

            if (searchResults.length > 0) {
                const bestScore = searchResults[0].displayPercent;
                if (bestScore > 85) {
                    searchResults = searchResults.filter(r => r.displayPercent >= 40);
                }
                searchResults = searchResults.slice(0, 12); 
            }

            let resultsHtml = '';
            if (searchResults.length > 0) {
                resultsHtml = `<div class="mt-4 space-y-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Found ${searchResults.length} relevant results based on your scenario.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${searchResults.map((req, index) => renderCard(req, req.displayPercent, index === 0)).join('')}
                    </div>
                </div>`;
            } else if (tokens.length > 0) {
                resultsHtml = `<div class="text-center py-8 bg-gray-50 dark:bg-gray-800/50 rounded-xl mt-4 border border-gray-100 dark:border-gray-700">
                    ${getIcon('Search')}
                    <p class="mt-2 text-lg font-semibold text-gray-700 dark:text-gray-200">No matches found</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Try using simpler keywords like "refund" or "broken".</p>
                </div>`;
            } else {
                 resultsHtml = `<div class="text-center py-8 bg-gray-50 dark:bg-gray-800/50 rounded-xl mt-4 border border-gray-100 dark:border-gray-700">
                    <div class="inline-block p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-full mb-2 text-indigo-500">${getIcon('Search')}</div>
                    <p class="mt-2 text-lg font-semibold text-gray-700 dark:text-gray-200">Inquiry Search</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 max-w-xs mx-auto">Paste the customer's message or describe the issue to find the best request type.</p>
                </div>`;
            }

            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="font-bold text-gray-700 dark:text-gray-200 mb-3 text-lg">Keyword Search</h2>
                    <div class="relative">
                        <input id="search-input" type="text" value="${currentSearchTerm}" placeholder="Describe the customer issue..." 
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white outline-none placeholder-gray-500 dark:placeholder-gray-400 transition-all shadow-sm" />
                        <div class="absolute left-3 top-3.5">${getIcon('Search')}</div>
                    </div>
                    ${resultsHtml}
                </div>
            `;
        }

        function renderApp(term = searchTerm) {
            if (isLoading) {
                appDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-64 gap-4">${getIcon('Loader')}<span>Loading Request Data...</span></div>`;
                return;
            }
            if (errorMsg) {
                appDiv.innerHTML = `
                    <div class="p-6 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-200 rounded-xl text-center flex flex-col items-center">
                        <p class="font-bold text-lg">Connection Error</p>
                        <p class="mt-2 mb-4 text-sm">${errorMsg}</p>
                        <button id="refresh-btn-err" class="bg-red-100 hover:bg-red-200 text-red-800 font-bold py-2 px-4 rounded inline-flex items-center transition-colors text-sm">
                            ${getIcon('Refresh')} <span class="ml-2">Retry Connection</span>
                        </button>
                    </div>`;
                document.getElementById('refresh-btn-err')?.addEventListener('click', fetchData);
                return;
            }

            const l1Opts = getUniqueOptions('L1');
            const l2Opts = getUniqueOptions('L2', selectedL1);
            const l3Opts = getUniqueOptions('L3', selectedL1, selectedL2);
            const isL3Enabled = !!selectedL2 && l3Opts.length > 0;

            appDiv.innerHTML = `
                <div class="max-w-5xl mx-auto space-y-8 pb-12">
                    <header class="border-b dark:border-gray-700 pb-4">
                        <!-- Logo Area -->
                        <div class="flex justify-center mb-4 h-16 items-center">
                             <img src="${LOGO_URL}" 
                                  alt="Tempo Fitness" 
                                  class="h-16 w-auto object-contain mix-blend-multiply dark:mix-blend-normal dark:brightness-0 dark:invert" 
                                  onerror="this.style.display='none'; document.getElementById('logo-text-fallback').style.display='block';" />
                             <div id="logo-text-fallback" style="display:none;" class="text-2xl font-black tracking-tighter text-gray-800 dark:text-white logo-text">
                                TEMPO
                             </div>
                        </div>

                        <!-- Title and Controls -->
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-extrabold text-gray-900 dark:text-white tracking-tight">Request Type Helper</h1>
                            <div class="flex gap-3">
                                <button id="theme-btn" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 transition-colors" aria-label="Toggle Theme">
                                    ${isDarkMode ? getIcon('Sun') : getIcon('Moon')}
                                </button>
                                <button id="refresh-btn" class="bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-semibold py-2 px-4 rounded-lg inline-flex items-center transition-colors border border-gray-300 dark:border-gray-600 shadow-sm">
                                    ${getIcon('Refresh')} <span class="ml-2">Refresh</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="flex flex-col gap-8">
                        <!-- Search Panel -->
                        ${renderSearchPanel(term)}

                        <!-- Tree Panel -->
                        <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="font-bold text-gray-700 dark:text-gray-200 text-lg">Request Type Tree</h2>
                                <button id="reset-tree-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 text-xs font-semibold py-1.5 px-3 rounded inline-flex items-center transition-colors">
                                    ${getIcon('X')} <span class="ml-1">Reset Selection</span>
                                </button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                ${renderDropdown('l1-select', 'Level 1', l1Opts, selectedL1, true)}
                                ${renderDropdown('l2-select', 'Level 2', l2Opts, selectedL2, !!selectedL1)}
                                ${renderDropdown('l3-select', 'Level 3', l3Opts, selectedL3, isL3Enabled)}
                            </div>
                            ${currentFinalRequest ? `
                                <div class="border-t dark:border-gray-700 pt-6 animate-fade-in">
                                    <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Selected Details</h3>
                                    ${renderCard(currentFinalRequest)}
                                </div>
                            ` : ''}
                        </section>
                    </main>
                    
                    <footer class="text-center text-xs text-gray-400 dark:text-gray-500">
                        Connected to Live Sheet â€¢ ${requestTypesData.length} Request Types Loaded
                    </footer>
                </div>
            `;

            document.getElementById('l1-select')?.addEventListener('change', handleL1Change);
            document.getElementById('l2-select')?.addEventListener('change', handleL2Change);
            document.getElementById('l3-select')?.addEventListener('change', handleL3Change);
            document.getElementById('refresh-btn')?.addEventListener('click', fetchData);
            document.getElementById('theme-btn')?.addEventListener('click', handleThemeToggle);
            document.getElementById('reset-tree-btn')?.addEventListener('click', handleResetTree);
            
            const searchInput = document.getElementById('search-input');
            if(searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
                if (document.activeElement === searchInput || term.length > 0) {
                    searchInput.focus();
                    const len = searchInput.value.length;
                    searchInput.setSelectionRange(len, len);
                }
            }
        }

        // Initialize
        fetchData();
    </script>
</body>
</html>